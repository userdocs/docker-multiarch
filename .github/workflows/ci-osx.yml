name: ci - osx

on:
  workflow_call:
    inputs:
      brew_cellar:
        type: string
        required: true
      target:
        type: string
        required: true
      source_repo:
        type: string
        required: true
      source_branch:
        type: string
        required: true
      artifacts_only:
        type: string
        required: true

env:
  GH_TOKEN: "${{ github.TOKEN }}"

jobs:
  build:
    runs-on: ${{ inputs.target }}

    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Install packages
        run: |
          brew update || brew update-reset
          brew install autoconf automake libtool

      - name: Check openssl
        run: ls -la ${{ inputs.brew_cellar }}/openssl@3/*/lib

      - name: Openssl Static Libraries
        run: |
          mkdir -p ${{ github.workspace }}/openssl_libs
          cp -fv ${{ inputs.brew_cellar }}/openssl@3/*/lib/libcrypto.a ${{ github.workspace }}/openssl_libs/
          cp -fv ${{ inputs.brew_cellar }}/openssl@3/*/lib/libssl.a ${{ github.workspace }}/openssl_libs/

      - name: Check openssl_libs
        run: ls -la openssl_libs

      - name: Clone iperf3 repository
        run: git clone --no-tags --single-branch --branch ${{ inputs.source_branch }} --shallow-submodules --recurse-submodule --depth 1 ${{ inputs.source_repo }} iperf3

      - name: Bootstrap
        working-directory: iperf3
        run: ./bootstrap.sh

      - name: Set CC
        run: printf '%s\n' "LDFLAGS=-L${{ github.workspace }}/openssl_libs" >> "$GITHUB_ENV"

      - name: Configure
        working-directory: iperf3
        run: ./configure --enable-shared=no --disable-silent-rules --disable-profiling --prefix=${{ github.workspace }}/build

      - name: Make
        working-directory: iperf3
        run: make -j"$(sysctl -n hw.logicalcpu)"

      - name: Make install
        working-directory: iperf3
        run: make install

      - name: Test
        run: |
          printf '\n%b\n\n' "ðŸŸ¦"
          ${{ github.workspace }}/build/bin/iperf3 --version
          printf '\n%b\n\n' "ðŸŸ¦"
          file ${{ github.workspace }}/build/bin/iperf3
          printf '\n%b\n\n' "ðŸŸ¦"
          otool -L ${{ github.workspace }}/build/bin/iperf3

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: iperf3-${{ matrix.target }}
          path: ${{ github.workspace }}/build

      - name: Upload artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: iperf3-${{ matrix.target }}-config.log
          path: ${{ github.workspace }}/iperf3/config.log
