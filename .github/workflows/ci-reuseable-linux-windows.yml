name: ci - main reusable caller

on:
  schedule:
    - cron: "*/15 * * * *" # Run every 5 minutes
  workflow_dispatch:
    inputs:
      source_repo:
        description: "Define the git repo used for the build"
        required: true
        default: "https://github.com/esnet/iperf.git"
      source_branch:
        description: "Specify the branch to build"
        required: true
        default: "master"
      skip_new_tag_check:
        description: "Skip new tag check?"
        required: true
        default: false
        type: boolean
      force_build:
        description: "Force a build"
        required: false
        default: false
        type: boolean
      linux_build_type:
        description: "Build iperf3 using qemu emulation"
        required: true
        default: false
        type: boolean
      artifacts_only:
        description: "No release - artifacts only"
        required: true
        default: false
        type: boolean
      linux:
        description: "Skip Linux build"
        type: boolean
        required: true
        default: false
      windows:
        description: "Skip Windows build"
        type: boolean
        required: true
        default: false
      skip_rerun:
        description: "Skip rerun?"
        required: true
        default: false
        type: boolean
      retries:
        description: "Number of rerun retries"
        required: true
        default: "1"
        type: choice
        options: ["1", "2", "3", "4", "5", "6", "7", "8", "9"]

permissions:
  actions: write
  id-token: write
  contents: write
  attestations: write
  packages: write

env:
  GH_TOKEN: "${{ github.TOKEN }}"

jobs:
  Check-for-new-iperf3-tag:
    if: github.event.inputs.skip_new_tag_check == 'false' || contains('inputs.skip_new_tag_check', 'true')
    uses: ./.github/workflows/ci-check-for-new-release-tag.yml
    secrets: inherit
    with:
      force_build: ${{ github.event.force_build == 'false || contains('inputs.force_build', 'true')' }}

  Linux-Emulation:
    needs: Check-for-new-iperf3-tag
    if: always() && needs.Check-for-new-iperf3-tag.outputs.continue_build == 'yes' &&  inputs.linux == 'false' && inputs.linux_build_type == 'true'
    uses: ./.github/workflows/ci-linux-emulation.yml
    secrets: inherit
    with:
      source_repo: ${{ github.event.source_repo }}
      source_branch: ${{ github.event.source_branch }}
      artifacts_only: ${{ github.event.artifacts_only }}

  Linux-Crossbuild:
    needs: Check-for-new-iperf3-tag
    if: always() && needs.Check-for-new-iperf3-tag.outputs.continue_build == 'yes' && inputs.linux == 'false' && inputs.linux_build_type == 'false'
    uses: ./.github/workflows/ci-linux-crossbuild.yml
    secrets: inherit
    with:
      source_repo: ${{ github.event.source_repo }}
      source_branch: ${{ github.event.source_branch }}
      artifacts_only: ${{ github.event.artifacts_only }}

  Docker:
    needs: [Check-for-new-iperf3-tag, Linux-Emulation, Linux-Crossbuild]
    if: always() && (needs.Linux-Emulation.result == 'success' || needs.Linux-Crossbuild.result == 'success') && ( needs.Check-for-new-iperf3-tag.outputs.continue_build == 'yes' && inputs.linux == 'false' && inputs.artifacts_only == 'false' )
    uses: ./.github/workflows/ci-docker.yml
    secrets: inherit

  Windows:
    needs: [Check-for-new-iperf3-tag]
    if: needs.Check-for-new-iperf3-tag.outputs.continue_build == 'yes' && inputs.windows == 'false'
    uses: ./.github/workflows/ci-windows.yml
    secrets: inherit
    with:
      source_repo: ${{ github.event.source_repo }}
      source_branch: ${{ github.event.source_branch }}
      artifacts_only: ${{ github.event.artifacts_only }}

  rerun-on-failure:
    needs:
      [
        Check-for-new-iperf3-tag,
        Linux-Emulation,
        Linux-Crossbuild,
        Docker,
        Windows,
      ]
    if: always() && failure() && inputs.skip_rerun == '0'
    name: rerun-on-failure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Trigger rerun workflow on job failures
        run: |
          inputs_retries="${{ github.event.retries }}"
          gh workflow run rerun.yml -f run_id=${{ github.run_id }} -f attempts=${{ github.run_attempt }} -f retries=${inputs_retries:-1}
