# .github/workflows/dev-linux-windows.yml
name: ci - reusable

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: "Define the git repo used for the build"
        required: true
        default: "https://github.com/esnet/iperf.git"
      source_branch:
        description: "Specify the branch to build"
        required: true
        default: "master"
      artifacts_only:
        description: "No release - artifacts only"
        required: true
        default: true
        type: boolean
      linux:
        description: "Run Linux build"
        type: boolean
        required: true
        default: true
      windows:
        description: "Run Windows build"
        type: boolean
        required: true
        default: true
      skip_rerun:
        description: "Skip rerun?"
        required: true
        default: true
        type: boolean
      retries:
        description: "Number of rerun retries"
        required: true
        default: "1"
        type: choice
        options: ["1", "2", "3", "4", "5", "6", "7", "8", "9"]

permissions:
  actions: write
  id-token: write
  contents: write
  attestations: write

env:
  GH_TOKEN: "${{ github.TOKEN }}"

jobs:
  Linux:
    if: ${{ github.event.inputs.linux == 'true' }}
    uses: ./.github\workflows\ci-linux.yml
    secrets:
      vt_api_key: ${{ secrets.VT_API_KEY }}
      GH_TOKEN: ${{ github.token }}
    with:
      source_repo: ${{ inputs.source_repo }}
      source_branch: ${{ inputs.source_branch }}
      artifacts_only: ${{ inputs.artifacts_only }}

  Docker:
    if: ${{ github.event.inputs.linux == 'true' }}
    uses: ./.github\workflows\ci-docker.yml

  Windows:
    if: ${{ github.event.inputs.windows == 'true' }}
    uses: ./.github\workflows\ci-windows.yml
    secrets:
      vt_api_key: ${{ secrets.VT_API_KEY }}
      GH_TOKEN: ${{ github.token }}
    with:
      source_repo: ${{ inputs.source_repo }}
      source_branch: ${{ inputs.source_branch }}
      artifacts_only: ${{ inputs.artifacts_only }}

  rerun-on-failure:
    needs: [Linux, Windows]
    if: failure() && inputs.skip_rerun == '0'
    name: rerun-on-failure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Trigger rerun workflow on job failures
        run: |
          inputs_retries="${{ inputs.retries }}"
          gh workflow run rerun.yml -f run_id=${{ github.run_id }} -f attempts=${{ github.run_attempt }} -f retries=${inputs_retries:-1}
